<!DOCTYPE html>
<html>
  <head>
    <title>Intro to Kernel Debugging</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      #slide-oops .remark-code{
	      font-size: 0.75em;
      }
      #slide-OOPSes .remark-code{
	      font-size: 0.75em;
      }
      .remark-container {
	      background-color: #2164f3 ;
      }
	.full-height {
		background-size: auto 100%;
	}
	.full-width {
		background-size: 100% auto;
	}
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

name: Title 
class: center, middle

# Intro to Kernel Debugging:
just make the crashing stop!


Dave Chiluk
Linux Platform Engineer, Indeed.com

---

# Introduction - Dave Chiluk

a.k.a. the resume

- 2017-Current: Indeed.com, Linux Platform Engineer

- 2012-2017: Canonical, Ubuntu Sustaining Engineering
  - Worked closely with Ubuntu Kernel Team
  - Ubuntu Core Developer

- 2008-2012: IBM Linux Technology Center, Embedded Linux Support

- 2004-2008: IBM Embedded Linux Development

---
# Pets vs Cattle

### Scale Up
- Servers are like pets
- You name them, and when they get sick, you nurse them back to health

### Scale Out
- Servers are like cattle
- You number them, and when they get sick, you shoot them
#### Bill Baker, Distinguished Engineer, Microsoft

---

# Pets vs Cattle vs Wolves

### Scale Up
- Servers are like pets
- You name them, and when they get sick, you nurse them back to health

### Scale Out
- Servers are like cattle
- You number them, and when they get sick, you shoot them
- ** If wolves start taking out too many cattle, shoot them too. **
#### Bill Baker, Distinguished Engineer, Microsoft

---
# Case Study: The Indeed.com xfs crash 

- SYSENG-2163: Rekick iad-mexec3  
Description: "We need to rekick iad-mexec3 due to filesystem corruption. Currently this host is in downtime and removed from the mesos cluster."

--

- SYSENG-2336: Rekick sjc-mexec11

--

- SYSENG-2342: Rekick sjc-mexec13

--

- SYSENG-2398: replace iad-mexec3; /var is corrupt for the n'th time  

--

- SYSENG-2624: Rekick stg-mexec7: /var corrupted  

- SYSENG-2723: Rekick iad-mexec6  

- SYSENG-2770: /var corrupted on iad-mexec16  

- SYSENG-2802: Fix the corrupt disk issue on iad-mexec10 (kernel bug)  

- SYSENG-2849: hkg-mexec5/6 var corruption  

- SYSENG-2850: Monitor on corrupt filesystems  

- SYSENG-3056: sjc-mexec28 /var corruption by xfs bug  

???
Anyone notice something that might cause a problem?

---

# Step #1: Gather Information

- Collect Logs
  - First Oops
  - Exact kernel versions

- Consider logging console output

- Consider rsyslog

- Possibly turn on crashdump collection

---
name: oops
template: oops

# Case Study: The Oops
```log
XFS (dm-4): Internal error XFS_WANT_CORRUPTED_GOTO at line 3505 of file fs/xfs/libxfs/xfs_btree.c.  Caller xfs_free_ag_extent+0x35d/0x7a0 [xfs]
CPU: 18 PID: 9896 Comm: mesos-slave Not tainted 4.10.10-1.el7.elrepo.x86_64 #1
Hardware name: Supermicro PIO-618U-TR4T+-ST031/X10DRU-i+, BIOS 2.0 12/17/2015
Call Trace:
dump_stack+0x63/0x87
xfs_error_report+0x3b/0x40 [xfs]
? xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_btree_insert+0x1b0/0x1c0 [xfs]
xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_free_extent+0xbb/0x150 [xfs]
xfs_trans_free_extent+0x4f/0x110 [xfs]
? xfs_trans_add_item+0x5d/0x90 [xfs] 
xfs_extent_free_finish_item+0x26/0x40 [xfs]
xfs_defer_finish+0x149/0x410 [xfs]
xfs_remove+0x281/0x330 [xfs]
xfs_vn_unlink+0x55/0xa0 [xfs]
vfs_rmdir+0xb6/0x130
do_rmdir+0x1b3/0x1d0
SyS_rmdir+0x16/0x20
do_syscall_64+0x67/0x180
entry_SYSCALL64_slow_path+0x25/0x25
RIP: 0033:0x7f85d8d92397
RSP: 002b:00007f85cef9b758 EFLAGS: 00000246 ORIG_RAX: 0000000000000054
RAX: ffffffffffffffda RBX: 00007f858c00b4c0 RCX: 00007f85d8d92397
RDX: 00007f858c09ad70 RSI: 0000000000000000 RDI: 00007f858c09ad70
RBP: 00007f85cef9bc30 R08: 0000000000000001 R09: 0000000000000002
R10: 0000006f74656c67 R11: 0000000000000246 R12: 00007f85cef9c640
R13: 00007f85cef9bc50 R14: 00007f85cef9bcc0 R15: 00007f85cef9bc40
XFS (dm-4): xfs_do_force_shutdown(0x8) called from line 236 of file fs/xfs/libxfs/xfs_defer.c.  Return address = 0xffffffffa028f087
XFS (dm-4): Corruption of in-memory data detected.  Shutting down filesystem
XFS (dm-4): Please umount the filesystem and rectify the problem(s)
```
???
* Oops: #
* Modules List
* Taint flags
* Code: Text code, use decode_code

OK now we have the information, next let's get the sources.

---

# Case Study: Gather problem specific data

### xfs-metadump
* Copies filesystem metadata to a file, while obfuscating specifics.  No data is copied.

### xfs-restore
* Takes a dump, and restores it to a filesystem. 
* Can be a loop device against a sparse raw file.

---

# Step #2: Getting the sources

- Centos

  - https://git.centos.org/project/rpms
  - git clone  https://git.centos.org/git/centos-git-common.git 
  - git checkout c7
  - centos-git-common/get_sources.sh

--
  - All you get is an RPM source tree, with no git searchable patch history, and very few broken out patches

--

- Ubuntu / Debian

  - apt-get source linux-image-$(uname-r)

--
  - http://kernel.ubuntu.com/git/?q=ubuntu%2F
  - git clone git://kernel.ubuntu.com/ubuntu/ubuntu-*
  - $ fakeroot debian/rules binary-generic

--

- Choose a distribution/Kernel that has useful access to source code.

???
I prefer distributions that provide git trees with full history, and documentation.

---
# Step #2: Getting the sources
- Mainline Kernel
  - Where all active kernel development eventually gets merged
  - git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
  - Maintained by Linus Torvalds

- Stable Kernel
  - Release kernels + bug fixes.
  - git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
  - Maintained by Greg Kroah-Hartman
  - Make sure to check out the correct version branch
  - **This is the branch that the elrepo kernel we use comes from**

--

- Subsystem development trees.
  - XFS git://git.kernel.org/pub/scm/linux/kernel/git/djwong/xfs-linux.git
  - Networking git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git

---
# Step #2: Kernel Structure
- Documentation/
  - Start here.
  - process/ - Explains how to interact with the community
  - admin-guide/ - RTFM
  - admin-guide/bug-hunting.rst
- mm/
- net/
- fs/
- arch/
- drivers/
- firmware/
- scripts/
  - get_maintainer.pl
  - checkpatch.pl
  - decodecode - Analyzes "code" output in an Oops
  - faddr2line - translates function+offset output to file:line 

???
bug-hunting.rst renamed from oops-tracing.txt

---
name: OOPSes
# Step #3: Oops Analysis

```log
------------[ cut here ]------------
WARNING: CPU: 1 PID: 28102 at kernel/module.c:1108 module_put+0x57/0x70
Modules linked in: dvb_usb_gp8psk(-) dvb_usb dvb_core nvidia_drm(PO) nvidia_modeset(PO) snd_hda_codec_hdmi snd_hda_intel snd_hda_codec snd_hwdep snd_hda_core snd_pcm snd_timer snd soundcore nvidia(PO) [last unloaded: rc_core]
CPU: 1 PID: 28102 Comm: rmmod Tainted: P        WC O 4.8.4-build.1 #1
Hardware name: MSI MS-7309/MS-7309, BIOS V1.12 02/23/2009
 00000000 c12ba080 00000000 00000000 c103ed6a c1616014 00000001 00006dc6
 c1615862 00000454 c109e8a7 c109e8a7 00000009 ffffffff 00000000 f13f6a10
 f5f5a600 c103ee33 00000009 00000000 00000000 c109e8a7 f80ca4d0 c109f617
Call Trace:
 [<c12ba080>] ? dump_stack+0x44/0x64
 [<c103ed6a>] ? __warn+0xfa/0x120
 [<c109e8a7>] ? module_put+0x57/0x70
 [<c109e8a7>] ? module_put+0x57/0x70
 [<c103ee33>] ? warn_slowpath_null+0x23/0x30
 [<c109e8a7>] ? module_put+0x57/0x70
 [<f80ca4d0>] ? gp8psk_fe_set_frontend+0x460/0x460 [dvb_usb_gp8psk]
 [<c109f617>] ? symbol_put_addr+0x27/0x50
 [<f80bc9ca>] ? dvb_usb_adapter_frontend_exit+0x3a/0x70 [dvb_usb]
 [<f80bb3bf>] ? dvb_usb_exit+0x2f/0xd0 [dvb_usb]
 [<c13d03bc>] ? usb_disable_endpoint+0x7c/0xb0
 [<f80bb48a>] ? dvb_usb_device_exit+0x2a/0x50 [dvb_usb]
 [<c13d2882>] ? usb_unbind_interface+0x62/0x250
 [<c136b514>] ? __pm_runtime_idle+0x44/0x70
 [<c13620d8>] ? __device_release_driver+0x78/0x120
 [<c1362907>] ? driver_detach+0x87/0x90
 [<c1361c48>] ? bus_remove_driver+0x38/0x90
 [<c13d1c18>] ? usb_deregister+0x58/0xb0
 [<c109fbb0>] ? SyS_delete_module+0x130/0x1f0
 [<c1055654>] ? task_work_run+0x64/0x80
 [<c1000fa5>] ? exit_to_usermode_loop+0x85/0x90
 [<c10013f0>] ? do_fast_syscall_32+0x80/0x130
 [<c1549f43>] ? sysenter_past_esp+0x40/0x6a
---[ end trace 6ebc60ef3981792f ]---
```

---
# Step #3: Oops Analysis

```log
XFS (dm-4): Internal error XFS_WANT_CORRUPTED_GOTO at line 3505 of file 
  fs/xfs/libxfs/xfs_btree.c. Caller xfs_free_ag_extent+0x35d/0x7a0 [xfs]
CPU: 18 PID: 9896 Comm: mesos-slave Not tainted 4.10.10-1.el7.elrepo.x86_64 #1
```
* Exact Kernel Version + line number.

--

```c
3462 xfs_btree_insert(
...
3493         /*
3494          * Insert nrec/nptr into this level of the tree.
3495          * Note if we fail, nptr will be null.
3496          */
3497         error = xfs_btree_insrec(pcur, level, &nptr, &rec, key,
3498                 &ncur, &i);
3499         if (error) {
3500             if (pcur != cur)
3501                 xfs_btree_del_cursor(pcur, XFS_BTREE_ERROR);
3502             goto error0;
3503         }
3504 
3505         XFS_WANT_CORRUPTED_GOTO(cur->bc_mp, i == 1, error0);
```
???
i = status return code for passing up the stack. success/failure.

There are about 4 ways that stat could be set to 1 by xfs_btree_insrec

---
# Step #3: Oops Analysis: The stack trace
```log
Call Trace:
dump_stack+0x63/0x87
xfs_error_report+0x3b/0x40 [xfs]
? xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_btree_insert+0x1b0/0x1c0 [xfs]
xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_free_extent+0xbb/0x150 [xfs]
xfs_trans_free_extent+0x4f/0x110 [xfs]
? xfs_trans_add_item+0x5d/0x90 [xfs] 
xfs_extent_free_finish_item+0x26/0x40 [xfs]
xfs_defer_finish+0x149/0x410 [xfs]
xfs_remove+0x281/0x330 [xfs]
xfs_vn_unlink+0x55/0xa0 [xfs]
vfs_rmdir+0xb6/0x130
do_rmdir+0x1b3/0x1d0
SyS_rmdir+0x16/0x20
do_syscall_64+0x67/0x180
entry_SYSCALL64_slow_path+0x25/0x25
```

* Can use gdb to perform math on a debug symbol enabled vmlinux

```shell
$ gdb vmlinux
(gdb) l *xfs_btree_insert+0x1b0/0x1c0
```

---

# Step #3: Oops Analysis: The Registers
```log
RIP: 0033:0x7f85d8d92397
RSP: 002b:00007f85cef9b758 EFLAGS: 00000246 ORIG_RAX: 0000000000000054
RAX: ffffffffffffffda RBX: 00007f858c00b4c0 RCX: 00007f85d8d92397
RDX: 00007f858c09ad70 RSI: 0000000000000000 RDI: 00007f858c09ad70
RBP: 00007f85cef9bc30 R08: 0000000000000001 R09: 0000000000000002
R10: 0000006f74656c67 R11: 0000000000000246 R12: 00007f85cef9c640
R13: 00007f85cef9bc50 R14: 00007f85cef9bcc0 R15: 00007f85cef9bc40
```
### Disassemble the kernel
- Get the debuginfo package
- $ objdump -r -S -l --disassemble vmlinux > dump.out

* Register to argument mapping defined in ./arch/x86/entry/calling.h
* x86 function call convention, 64-bit:

```c
arguments            |  callee-saved      | extra caller-saved | return 
(callee-clobbered)   |                    | (callee-clobbered) |  
-------------------- | -------------------| -------------------| -------------
rdi rsi rdx rcx r8-9 | rbx rbp [*] r12-15 | r10-11             | rax, rdx [**] 
``` 

???
RIP: Register Instruction Pointer
RSP: Register Stack Pointer

This isn't as useful to us, since the registers have likely been modified by the error path.

Additionally since we don't have a full memory dump they are only half-useful.

---

# Step #4: Check for fixes

* Google 
  * Stack Trace
  * Mailing list archives
  * Related problems given your understanding of the problem.

* Check the git commit logs
```shell
 $ git log -r v4.4.. -i --grep "crash" fs/xfs
```
???
TODO: Goose egg

---

# Step #5: Gather even more info

* Enable crashdump
* Instrument the kernel code (kprintf) / Build a custom kernel.
* systemtap
* eBPF
* ftrace, jprobes, kprobes
* Analyze filesystem metadata offline

---

# Step #6: Engaging the community.

--
* Mailing lists
--

  * ~~lkml~~!
  * patchwork.kernel.org
  * xfs-devel mailing list
  * Other subsystem specific lists
* IRC

---
# Step #6: Engaging the community

* E-mail sent to xfs devel mailing list
> "My best guess given code analysis is that we are unable to allocate a new node in the allocation group btree free-list"

--

* Flamed
> "/me shakes his head.
> 
> That filesystem started as a 2.5GB image and was grown to 1TB on
> deployment. What could possibly go wrong?" <br>
> <div align="right">- Dave Chinner </div>

--
<center><h1>i.e. PEBKAC- You're Using It Wrong</h1></center>

---

# Step #6: Engaging the community

* E-mail sent to xfs devel mailing list
> "My best guess given code analysis is that we are unable to allocate a new node in the allocation group btree free-list"

* IRC

--
> "This is the problematic issue: commit 96f859d52bcb ("libxfs: pack the agfl header structure so XFS_AGFL_SIZE is correct")"
> ...
>
> "[I] need to resurrect the old patches [I] had that automatically detected this condition and fixed it."
> <div align="right"> - Dave Chinner</div>

--

```c
--- a/fs/xfs/libxfs/xfs_format.h
+++ b/fs/xfs/libxfs/xfs_format.h
@@ -786,7 +786,7 @@ typedef struct xfs_agfl {
        __be64          agfl_lsn;
        __be32          agfl_crc;
        __be32          agfl_bno[];     /* actually XFS_AGFL_SIZE(mp) */
-} xfs_agfl_t;
+} __attribute__((packed)) xfs_agfl_t;
```
---

# Step #6.5: The temporary fix

* Explicitly removed problematic patch
* Submitted patch removal to the elrepo kernel.
* Created a custom built xfs-repair that understands the patch.

--

### BUT
* There's no easy way to run xfs-repair on a root volume accross an entire cluster.

---
class: full-height

background-image: url(baby.jpg)

---

# Step #7: The Real fix

* Many conversations on IRC 

* 4 debates on xfs-devel over patch revisions 

--

* 2 months later a27ba2607 is accepted into the xfs-devel tree

---

# Step #8: The follow through.

* mainline

  * Linus merges patches from xfs-devel into 4.17rc1.

--

* linux-stable
  * Linux stable backport and submission to linux-stable mailing list
  * Greg KH, accepts the patches and adds them to the stable-queue git tree for review
  * Eventually merged to stable branches such as 4.4.

--

* Distro Kernels
  * Some distros follow linux-stable guidelines.
  * Check your distro just to make sure.

---
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
