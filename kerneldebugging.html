<!DOCTYPE html>
<html>
  <head>
    <title>Intro to Kernel Debugging</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      #slide-log .remark-code{
	      font-size: 0.75em;
      }
      .remark-container {
	      background-color: #2164f3 ;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

name: Title 
class: center, middle

# Intro to Kernel Debugging:
just make the crashing stop!


Dave Chiluk
Linux Platform Engineer, Indeed.com

---

# Agenda

1. Introduction
2. Deep-dive
3. ...

---
# Introduction - Dave Chiluk

a.k.a. the resume

- 2017-Current: Indeed.com, Linux Platform Engineer

- 2012-2017: Canonical, Ubuntu Sustaining Engineering
  - Worked closely with Ubuntu Kernel Team
  - Became an Ubuntu Core Dev

- 2008-2012: IBM Linux Technology Center, Embedded Linux Support

- 2004-2008: IBM Embeded Linux Development

---
# Pets vs Cattle

### Scale Up
- Servers are like pets
- You name them, and when they get sick, you nurse them back to health

### Scale Out
- Servers are like cattle
- You number them, and when they get sick, you shoot them
#### Bill Baker, Distinguished Engineer, Microsoft

---

# Pets vs Cattle vs Wolves

### Scale Up
- Servers are like pets
- You name them, and when they get sick, you nurse them back to health

### Scale Out
- Servers are like cattle
- You number them, and when they get sick, you shoot them
- ** If wolves start taking out too many cattle, shoot them too. **
#### Bill Baker, Distinguished Engineer, Microsoft

---
# Case Study: Indeed.com crash 

- SYSENG-2163: Rekick iad-mexec3  
Description: "We need to rekick iad-mexec3 due to filesystem corruption. Currently this host is in downtime and removed from the mesos cluster."

--

- SYSENG-2336: Rekick sjc-mexec11

--

- SYSENG-2342: Rekick sjc-mexec13

--

- SYSENG-2398: replace iad-mexec3; /var is corrupt for the n'th time  

--

- SYSENG-2624: Rekick stg-mexec7: /var corrupted  

- SYSENG-2723: Rekick iad-mexec6  

- SYSENG-2770: /var corrupted on iad-mexec16  

- SYSENG-2802: Fix the corrupt disk issue on iad-mexec10 (kernel bug)  

- SYSENG-2849: hkg-mexec5/6 var corruption  

- SYSENG-2850: Monitor on corrupt filesystems  

- SYSENG-3056: sjc-mexec28 /var corruption by xfs bug  

???
Anyone notice something that might cause a problem?

---

# Step #1: Gather Information

- Collect Logs
  - Stack Traces
  - OOPS
  - Exact kernel versions

- Consider logging console output

- Consider rsyslog

- Possibly turn on crashdump collection

---
name: log


# Case Study: The Information
```log
XFS (dm-4): Internal error XFS_WANT_CORRUPTED_GOTO at line 3505 of file fs/xfs/libxfs/xfs_btree.c.  Caller xfs_free_ag_extent+0x35d/0x7a0 [xfs]
CPU: 18 PID: 9896 Comm: mesos-slave Not tainted 4.10.10-1.el7.elrepo.x86_64 #1
Hardware name: Supermicro PIO-618U-TR4T+-ST031/X10DRU-i+, BIOS 2.0 12/17/2015
Call Trace:
dump_stack+0x63/0x87
xfs_error_report+0x3b/0x40 [xfs]
? xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_btree_insert+0x1b0/0x1c0 [xfs]
xfs_free_ag_extent+0x35d/0x7a0 [xfs]
xfs_free_extent+0xbb/0x150 [xfs]
xfs_trans_free_extent+0x4f/0x110 [xfs]
? xfs_trans_add_item+0x5d/0x90 [xfs] 
xfs_extent_free_finish_item+0x26/0x40 [xfs]
xfs_defer_finish+0x149/0x410 [xfs]
xfs_remove+0x281/0x330 [xfs]
xfs_vn_unlink+0x55/0xa0 [xfs]
vfs_rmdir+0xb6/0x130
do_rmdir+0x1b3/0x1d0
SyS_rmdir+0x16/0x20
do_syscall_64+0x67/0x180
entry_SYSCALL64_slow_path+0x25/0x25
RIP: 0033:0x7f85d8d92397
RSP: 002b:00007f85cef9b758 EFLAGS: 00000246 ORIG_RAX: 0000000000000054
RAX: ffffffffffffffda RBX: 00007f858c00b4c0 RCX: 00007f85d8d92397
RDX: 00007f858c09ad70 RSI: 0000000000000000 RDI: 00007f858c09ad70
RBP: 00007f85cef9bc30 R08: 0000000000000001 R09: 0000000000000002
R10: 0000006f74656c67 R11: 0000000000000246 R12: 00007f85cef9c640
R13: 00007f85cef9bc50 R14: 00007f85cef9bcc0 R15: 00007f85cef9bc40
XFS (dm-4): xfs_do_force_shutdown(0x8) called from line 236 of file fs/xfs/libxfs/xfs_defer.c.  Return address = 0xffffffffa028f087
XFS (dm-4): Corruption of in-memory data detected.  Shutting down filesystem
XFS (dm-4): Please umount the filesystem and rectify the problem(s)
```
???
OK now we have the information, next let's get the sources.
---
# Case Study: Gather problem specific data


### xfs-metadump
Copies filesystem metadata to a file, while obfuscating specifics.  No data is copied.

### xfs-restore
Takes a dump, and restores it to a filesystem. Can be a loop device against a sparse raw file.
---

# Step #2: Getting the sources

- Centos

  - https://git.centos.org/project/rpms
  - git clone  https://git.centos.org/git/centos-git-common.git 
  - git checkout c7
  - centos-git-common/get_sources.sh

--
  - All you get is an RPM source tree, with no git searchable patch history, and very few broken out patches

--

- Ubuntu / Debian

  - apt-get source linux-image-$(uname-r)

--
  - http://kernel.ubuntu.com/git/?q=ubuntu%2F
  - git clone git://kernel.ubuntu.com/ubuntu/ubuntu-*
  - $ fakeroot debian/rules binary-generic

--

- Choose a distribution that has useful access to source code.

???
I prefer distributions that provide git trees with full history, and documentation.

---

# Kernel Sources
- Mainline Kernel
  - Where all active kernel development eventually gets merged
  - git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
  - Maintained by Linus Torvalds

- Stable Kernel
  - Release kernels + bug fixes.
  - git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
  - Maintained by Greg Kroah-Hartman
  - Make sure to check out the correct version branch

--

- Subsystem development trees.
  - XFS git://git.kernel.org/pub/scm/linux/kernel/git/djwong/xfs-linux.git
  - Networking git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git

---
# Kernel Structure
- Documentation/
  - Just learning, start here.
  - process/ - Explains how to interact with the community
- mm/
- net/
- fs/
- arch/
- drivers/
- firmware/
- scripts/
  - get_maintainer.pl
  - checkpatch.pl
  - decodecode - Analyzes "code" output in an OOPS
  - faddr2line - translates function+offset output to file:line 

---
# Step #3: Understand the area of affected source code.


---
# Case Study: Analyzing 


---

# XFS Bug

---

# Debuginfo getting it using it.

---

patchwork.kernel.org

---
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
